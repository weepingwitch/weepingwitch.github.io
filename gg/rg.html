<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  //global vars



  var running = true;


</script>

<head>
  <title>rythymgame</title>
  <style type="text/css">
    body{
      background-color:black;
    }
    canvas{
      margin: 0 auto;
    }
    button{
      width:4em;
      height:4em;
    }
    #main{
      width:100%;
      height:100%;
      border:2px solid black;
      position:relative;
      margin: 0 auto;
      background-color:black;
    }

    @media screen and (min-width: 781px) {
      #main{

        width:60%;

      }
    }
    #screen{
      position:relative;
      width:100%;
      height:60%;
      border:2px solid purple;
      background-color:black;
    }

    #log{
      position:relative;
      width:100%;
      height:8%;
      border:2px solid blue;
      background-color:blue;
    }
    #controls{
      display:block;
      position:relative;
      width:100%;
      height:30%;
      border:2px solid green;
      background-color:green;
    }
    #dpad{
      position:absolute;
      text-align:center;

      border: 1px solid black;

    }
    #buttons{
      position:absolute;
      text-align:center;

      border: 1px solid black;

      right:0;
    }
  </style>

</head>
<body>


  <div id="main">
    <div id="screen">

    </div>
    <div id="log">

    </div>
    <div id="controls">
      <div id="dpad">
        <button onmousedown="inpkey(w)">W</button><br>
        <button onmousedown="inpkey(a)">A</button>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button onmousedown="inpkey(d)">D</button><br>
        <button onmousedown="inpkey(s)">S</button>
      </div>
      <div id="buttons">
        <button onmousedown="inpkey(i)">I</button><br>
        <button onmousedown="inpkey(j)">J</button>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button onmousedown="inpkey(l)">L</button><br>
        <button onmousedown="inpkey(k)">K</button>
      </div>
    </div>

  </div>


  <script>
    //init code

    var cw = 18; var ch = 12;
    var screendiv = document.getElementById("screen");
    var log = document.getElementById("log");
        var vw = 32*cw, vh = 32*ch;
        var aw = screendiv.clientWidth;
        console.log(aw/vw);
        var sf = aw/vw;
        var uw = Math.floor(aw / cw);
        var ah = Math.floor(uw*ch);
    var gu = aw  / 120;
    screendiv.innerHTML="<canvas style='z-index:1;position:absolute;top:0' id='bgcanvas' width='" + aw + "' height='" + ah + "'></canvas>" +
    "<canvas style='z-index:2;position:absolute;top:0' id='mcanvas' width='" + aw + "' height='" + ah + "'></canvas>" +
    "<canvas style='z-index:3;position:absolute;top:0;'  id='uicanvas' width='" + aw + "' height='" + ah + "'></canvas>";
    screendiv.style.height = ah;
    var canv = document.getElementById('mcanvas');
    var uicanv = document.getElementById('uicanvas');
    var bgcanv = document.getElementById("bgcanvas");
    var ctx = canv.getContext('2d');
    var uictx = uicanv.getContext('2d');
    var bgctx = bgcanv.getContext('2d');
    ctx.scale(sf,sf);
    uictx.scale(sf,sf);
    bgctx.scale(sf,sf);


    bgctx.fillStyle = "gray";
    bgctx.fillRect((aw/4),10,32,32);
    bgctx.fillStyle = "blue";
    bgctx.fillRect(3*(aw/4),10,32,32);


    ctx.fillStyle = "purple";
    window.requestAnimationFrame(step)

    bgctx.strokeStyle = "white";
    bgctx.beginPath();
    bgctx.moveTo(0,ah-10);
    bgctx.lineTo(aw,ah-10);
    bgctx.stroke();

    bgctx.beginPath();
    bgctx.moveTo(0,ah-10-33);
    bgctx.lineTo(aw,ah-10-33);
    bgctx.stroke();
        bgctx.strokeStyle = "gray";
    bgctx.beginPath();
    bgctx.moveTo(0,ah-10-50);
    bgctx.lineTo(aw,ah-10-50);
    bgctx.stroke();
    bgctx.beginPath();
    bgctx.moveTo(0,ah-10-100);
    bgctx.lineTo(aw,ah-10-100);
    bgctx.stroke();
    uictx.strokeStyle = "green";







    //game loop

    let start, previousTimeStamp, dt, telapsed, tdt;
    var lastpress = performance.now();
    var lofs,dofs;
    var curbpm, lastbpm, curdif, lastdif, avgbpm, avgdif;
    var sincelastpress;
    var datarray = new Array(120); for (let i=0; i<120; ++i) datarray[i] = 0;
    tdt = 0;

    function step(timestamp)
    {

      if (start === undefined)
      {
        start = timestamp;
        previousTimeStamp = timestamp;
      }
      if (previousTimeStamp !== timestamp)
      {
        dt = timestamp-previousTimeStamp;
        tdt = tdt + dt;
      }
      //console.log("step time " + dt);
      telapsed = timestamp - start;
      sincelastpress = timestamp - lastpress;

      //console.log(telapsed + " vs " + tdt);

      //animate here


      //game elements

      clearcanv(ctx);

      ctx.fillRect((aw/4) + ((sincelastpress/curbpm)*aw)/2,10,32,32);

      //ui graph
      clearcanv(uictx);
      uictx.beginPath();
      uictx.moveTo(0,ah-10);
      for (let k=0; k<120; ++k){
        uictx.lineTo(k*gu,ah - datarray[k] - 10);

      }
      uictx.stroke();


      previousTimeStamp = timestamp;
      if (running){
        window.requestAnimationFrame(step)
      }
    }





    //input handling
    var keyspressed = [];
    window.addEventListener('keydown', function (e) {
      if (keyspressed.includes(e.keyCode )){

      }
      else{
        keyspressed.push(e.keyCode);
        switch(e.keyCode){
          case 87:
            inpkey("w");
            break;
          case 83:
            inpkey("s");
            break;
          case 65:
            inpkey("a");
            break;
          case 68:
            inpkey("d");
            break;
          case 73:
            inpkey("i");
            break;
          case 75:
            inpkey("k");
            break;
          case 74:
            inpkey("j");
            break;
          case 76:
            inpkey("l");
            break;
          case 27:
            inpkey("pause");
          default:
          break;
        }
      }
    });
    window.addEventListener('keyup', function (e) {

      keyspressed = keyspressed.filter(item => item != e.keyCode);

    });



    function inpkey(key){

      //input timing

      var ofs = performance.now() - lastpress;
      lastpress = performance.now();

      lastbpm = curbpm;
      lastdif = curdif;
      dofs = ofs - lofs;
      lofs = ofs;

      curdif = Math.abs(dofs);
      addtograph(curdif);
      curbpm = ofs;


      //console.log(curdif + " - " + curbpm);


      switch(key){
        case "w":
        break;
        case "a":
        break;
        case "s":
        break;
        case "d":
        break;
        case "i":
        break;
        case "j":
        break;
        case "k":
        break;
        case "l":
        break;
        case "pause":
        running = !running;
        if (running) window.requestAnimationFrame(step);
        break;

      }
    }



function addtograph(ofs){

datarray.push(ofs);
datarray.shift();
}

//utility functions

function clearcanv(cx){
  cx.clearRect(0,0,vw,vh);
}

function randfrom(myarray){
  return myarray[Math.floor(Math.random() * myarray.length)];
}

function randintinc(min, max) {
  return Math.floor(Math.random() * (max - min + 1) ) + min;
}

function lerp(v0, v1, t) {
    return v0*(1-t)+v1*t;
}




  </script>
</body>
</html>
