<!doctype html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Jacob's Sheep Manager</title>
       
        <style type="text/css">
            html{
                width:100%;
                height:100%;
            }
            body{
                background-color:#41980a;
                margin:0;
                padding:0;
                width:100%;
                height:100%;

            }

             #containerDiv{
                width:100%;
                height:100%;
            }
            
            #gridDiv{
                padding-top:1em;
                
                margin: 0 auto;
                
            }

            .mobile2 { display:flex;width:100%;}
            .mobile2 > div {
                    width:48%;
                }


            .item1 { grid-area: header; }
            .item2 { grid-area: menu; }
            .item3 { grid-area: main; }
            .item4 { grid-area: right; }
            .item5 { grid-area: footer; }

            .uigrid{
                display: grid;
                grid-template-areas:
                'header header header menu menu menu'
                'main main main right right right'
                'footer footer footer footer footer footer';
                grid-gap: 4px;
                background-color: #e1bf92;
            }

            .uigrid > div{
                padding: 5px 5px;
                margin:5px 5px;
            }


            .altlist li:nth-child(even) {
                background-color:#dfdfdf
            }
            

            @media (max-aspect-ratio: 1/1) {
                #gridDiv{
               
                width:95%;
               
                }

                .mobile2 { display:flex;height:100%;flex-direction: column;}

                .mobile2 > div {
                    width:100%;
                }

            }

            @media (aspect-ratio: 1/1) {
                #gridDiv{
                    width:95%;
            
                }
            }

            @media (min-aspect-ratio: 1/1) {

              
                #gridDiv{
                    
                    height:90%;
                    width:60%;
                    
                   
                }

            }
        
           
      

        </style>
         <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <div id="containerDiv">
            <div id="gridDiv">
                <div class="window" style="width:100%;position:relative;">
                    <div class="title-bar">
                      <div class="title-bar-text">Jacob's Sheep Manager</div>
                    </div>
                    <div class="window-body"  >
                <BR>
                        <menu role="tablist" id="tmenu">
                          <li role="tab" aria-selected="true"><a href="#" onclick="clickTab(0);">Farm Overview</a></li>
                          <li role="tab"><a href="#" onclick="clickTab(1);">Pasture Manager</a></li>
                          <li role="tab"><a href="#" onclick="clickTab(2);">Sheep Status</a></li>
                          <li role="tab"><a href="#" onclick="clickTab(3);">Farm Log</a></li>
                          
                      
                        </menu>
                        <div class="window" role="tabpanel">
                          <div class="window-body" id="tabbody" style="padding:1em;z-index: 1;">
<!-- begin tab view-->





                    <!-- end tab view-->
                          </div>
                        </div><hr>
<!-- end window content-->
                    </div>
                    <div class="status-bar" style="z-index: 0;">
                      <p class="status-bar-field">GenesOS 30.29-30.43</p>
                      <p class="status-bar-field" id="scount">Total Sheep:</p>
                      <p class="status-bar-field" style="text-align:right">Registered to Laban</p>
                    </div>
                  </div>
            </div>
        </div>
    <script>
    //vars
    

   var gd;
   var curtab = 0;
   var tb = document.getElementById("tabbody");
   var tm = document.getElementById("tmenu");
   var sc = document.getElementById("scount");
   var firstrender = true;

    //main
    
    init();

    function init(){
       
       
        game();
        clickTab(0);
    }



    function game(){
       gd = new gameData();
       
       
       addNewSheep(true,true);
       addNewSheep(false,true);
       addNewSheep(true, false);
       addNewSheep(true, false);
       addNewSheep(false,true);
       addNewSheep(true,true);
       addNewSheep(true,true);
       addNewSheep(false,false);
       addNewSheep();
       addNewSheep();
       addNewSheep();
       
       
      breedall();
      
       breedall();
       breedall();
       gd.curPid = 0;
     
       

    }

    function clickTab(tid){
        tb.innerHTML = "";
        curtab = tid;
       
        for (let t of tm.children){
            t.ariaSelected = false;
        }
        tm.children[tid].ariaSelected = true;

        switch (tid) {
            case 0:
              
                renderFarmOverview();
                break;
            case 1:
              
                renderPastureView();
                break;
            case 2:
               renderSheepView();
                break;
            case 3:
               renderLogView();
                break;
            case 4:
               tb.innerHTML = tid;
                break;
            case 5:
                tb.innerHTML = tid;
                break;
            }

        tb.innerHTML += "<BR><BR>";

    }

    function selectandviewsheep(sid){
        gd.curSid = sid;
        clickTab(2);
    }

    function selectandviewpasture(pid){
        gd.curPid = pid;
        clickTab(1);
    }

    function renderFarmOverview(){
        var out = "<div class='mobile2' ><div >";
        //out += renderAllSheepList();
        for (let p of gd.pastures){
            out += "<button onclick='selectandviewpasture(" + p.id + ")'>" + p.name + "</button><BR>";
            out += `<div class="progress-indicator segmented">
  <span class="progress-indicator-bar" style="width:` + (p.heldSheepIds.length/p.maxSheep)*100   + `%;" />
</div>`;    
        }

        out += "<BR><HR><BR>";
        out += "<button class='default' onclick='advancetime()'>Advance time</button><BR><BR>"
        out += "</div><div style='width:4%;'></div><div >";
            
            out += "<ul class='tree-view'>";
    var wi = 0;
for (var w of gd.longlog){
    out += "<li> ";
        
    if (wi == gd.time || firstrender){
        out += "<details open>";
    }
    else{
        out += "<details> ";
    }
   
        
    out += "<summary>week " + wi + "</summary>";
        out += "<ul>";
            for (var wu of w){
                out += "<li>" + wu + "</li>"
            }
        out += "</ul></details>"

    out += "</li>"
    wi += 1;
}
out += "</ul>"
            
        out += "</div></div>"
        tb.innerHTML = out;
        return out;
    }
    function changePastureMenu(npi){
       
      
        gd.curPid = npi;
        renderPastureView();
    }

    function prevpast(){
        gd.curPid -= 1;
        if (gd.curPid < 0) gd.curPid = 3;
        renderPastureView();
    }

    function nextpast(){
        gd.curPid += 1;
        if (gd.curPid > 3) gd.curPid = 0;
        renderPastureView();
    }

    function nextsheep(){
        var bsid = gd.pastures[gd.sheeps[gd.curSid].pid].heldSheepIds.indexOf(gd.curSid);
        bsid += 1;
        if (bsid > (gd.pastures[gd.sheeps[gd.curSid].pid].heldSheepIds.length -1)) bsid = 0;
        gd.curSid =  gd.pastures[gd.sheeps[gd.curSid].pid].heldSheepIds[bsid];
        renderSheepView();

    }

    function nextsheepall(){
        var bsid = gd.curSid += 1;
        if (bsid > gd.sheeps.length - 1) bsid = 0;
        gd.curSid = bsid;
        renderSheepView();
    }

    function prevsheep(){
        var bsid = gd.pastures[gd.sheeps[gd.curSid].pid].heldSheepIds.indexOf(gd.curSid);
        bsid -= 1;
        if (bsid < 0) bsid = (gd.pastures[gd.sheeps[gd.curSid].pid].heldSheepIds.length - 1);
        gd.curSid =  gd.pastures[gd.sheeps[gd.curSid].pid].heldSheepIds[bsid];
        renderSheepView();
    }

    function prevsheepall(){
        var bsid = gd.curSid -= 1;
        if (bsid < 0) bsid =  gd.sheeps.length - 1;
        gd.curSid = bsid;
        renderSheepView();
    }

    function changeSheepPastureMenu(){
        var psm = document.getElementById("pmselector");
        moveSheep(gd.curSid,psm.selectedIndex);


    }

    function renderPastureView(){
        var out = ` <input id='pname' type='text' value='` + gd.pastures[gd.curPid].name + `' onchange='renamepasture()' /> - 
        <button onclick='prevpast()'>prev pasture</button><button onclick="nextpast()">next pasture</button>
        <BR><HR><BR>Sheep in pasture:<BR>`;

        out += renderPastureList(gd.curPid);
        tb.innerHTML = out;
        return out;
    }

    function renderSheepView(){
        var s = gd.sheeps[gd.curSid];

        var out = "";
        out += `<div class="uigrid">
  <div class="item1 window"><input id='sname' type='text' value='` + s.name + `' onchange='renamesheep()' /></b> - #` + s.id + `</div>
  <div class="item2 window"> <button onclick='prevsheepall()'>prev sheep</button><button onclick="nextsheepall()">next sheep</button></div>
  <div class="item3 window">` + ((s.female)? "female" : "male") + ", ";
    if (s.retired) {
        out += "retired <BR>";
    }
    else{
        out += s.age + " weeks old" + "<BR>";
        }
    out += s.pattern + " " + s.color;
    out += `</div>
  <div class="item4 window ">`;
    if (s.msi != -1 && s.fsi != -1){
            out += "<a onclick='selectandviewsheep(" + s.fsi + ")'>mother: " + gd.sheeps[s.fsi].name + "</a> - ";
            out += "<a onclick='selectandviewsheep(" + s.msi + ")'>father: " + gd.sheeps[s.msi].name + "</a>";
            out += "<BR>";
        }
        if (s.kids.length > 0){
            out += "children: <ul>"
            for (let sk of s.kids){
                out += "<li onclick='selectandviewsheep(" + sk + ")'>" + gd.sheeps[sk].name + "</li>";
            }
            out += "</ul>";
        }
    
    
    out += ` </div>
  <div class="item5 window">`;
    if (!s.retired){
        out += "Assigned pasture: ";
        out += `<button onclick='selectandviewpasture(` + s.pid + `)' > ` + gd.pastures[s.pid].name  +`</button>
        Move to <select id="pmselector" oninput='changeSheepPastureMenu()'>
        <option ` + (s.pid==0 ? "selected" : "") + ` id='ps0'>` + gd.pastures[0].name + `</option>
        <option ` + (s.pid==1 ? "selected" : "") + ` id='ps1'>` + gd.pastures[1].name + `</option>
        <option ` + (s.pid==2 ? "selected" : "") + ` id='ps2'>` + gd.pastures[2].name + `</option>
        <option ` + (s.pid==3 ? "selected" : "") + ` id='ps3'>` + gd.pastures[3].name + `</option>
        </select>`;
    }
   out += `
    </div>
</div>`;
        

          
           
            
       
           
          
       
       

        //out += "spotg: " + s.sx + "," + s.sy + "<BR>";
        //out +="colorg: " +  s.cx + "," + s.cy + "<BR>";
       
        
        
        

        tb.innerHTML = out;
        return out;
    }



    function renderLogView(){

var out = "";

out += "<ul class='tree-view'>";
    var wi = 0;
for (var w of gd.longlog){
    out += "<li> ";
        
    if (wi == gd.time ){
        out += "<details open>";
    }
    else{
        out += "<details> ";
    }
   
        
    out += "<summary>week " + wi + "</summary>";
        out += "<ul>";
            for (var wu of w){
                out += "<li>" + wu + "</li>"
            }
        out += "</ul></details>"

    out += "</li>"
    wi += 1;
}
out += "</ul>"

tb.innerHTML = out;
return out;
}

    function renamesheep(){
        var sn = document.getElementById("sname").value;
        gd.sheeps[gd.curSid].name = sn;

    }

    function renamepasture(){
        var pn = document.getElementById("pname").value;
        gd.pastures[gd.curPid].name = pn;
        clickTab(1);
    }



    function addNewSheep( sx = -1, sy = -1, cx = -1, cy = -1){
        var s = new sheep(sx,sy, cx, cy )
        //log("baa! made " + s.name);
        gd.sheeps[s.id] = s;
        gd.pastures[gd.curPid].heldSheepIds.push(s.id);
       s.pid = gd.curPid;
       gd.curSid = s.id;
       s.age = randint(0,20);
       updateSheepCount();
        
    }

    function updateSheepCount(){
        gd.numalive = 0;
        for (let p of gd.pastures){
            gd.numalive += p.heldSheepIds.length
        }

        sc.innerHTML = "Total Sheep: " + gd.numalive;
    }


    function breedSheep(s1, s2){

        bcx = randfrom([s1.cx,s2.cx]);
        bcy = randfrom([s1.cy,s2.cy]);
        bsx = randfrom([s1.sx,s2.sx]);
        bsy = randfrom([s1.sy,s2.sy]);

        var bs = new sheep(bcx,bcy,bsx,bsy);
        log("baa! " + s1.name + " and " + s2.name + " gave birth to " + bs.name);
        bs.fsi = s1.id;
        bs.msi = s2.id;
        s1.kids.push(bs.id);
        s2.kids.push(bs.id);
        gd.curPid = s1.pid;
        gd.sheeps[bs.id] = bs;
        gd.pastures[gd.curPid].heldSheepIds.push(bs.id);
       bs.pid = gd.curPid;
       gd.curSid = bs.id;
       updateSheepCount();

    }

function advancetime(){
    firstrender = false;

     breedall();
}

    function breedall(){
        for (let p of gd.pastures){
            breedPasture(p);
            p.heldSheepIds.sort((a,b) => gd.sheeps[a].id - gd.sheeps[b].id);
        }
        
        
        
        clickTab(0);
        gd.time += 1;
        gd.longlog[gd.time]=[];
    }


    function breedPasture(p){
        console.log("breeding " + p.name);

        //split up by sex lmao
        var ms = [];
        var fs = [];
        p.heldSheepIds = shuffle(p.heldSheepIds)
        for (let si of p.heldSheepIds){
        
            var s = gd.sheeps[si];
            //age check and space check

            if (s.age > 49){
                log (s.name + " retired to the old sheeps farm.");
                s.retired = true;
                rem(p.heldSheepIds, s.id);
                updateSheepCount();

            }else{
                if (s.age > 0 ){
                        if (s.female){
                    
                    if ((fs.length > 0 ) && (s.sexy > gd.sheeps[fs[0]].sexy)){
                        
                        fs.unshift(si);
                    }else{
                        
                        fs.push(si);
                    }
                    }
                    else{
                    if ((ms.length > 0 ) && (s.sexy > gd.sheeps[ms[0]].sexy)){
                        ms.unshift(si);
                    }else{
                        ms.push(si);
                    }
                    }
            }
            
            //age up sheep
            s.age += 1;
           
            }
           
          


        }
       console.log(ms);
        console.log(fs);
        //breed pairs

        var done = false;
        if (fs.length <= 0 || ms.length <= 0){
                done = true;
            }
        while (!done){
            var sbf = gd.sheeps[fs.shift()];
            var sbm = gd.sheeps[ms.shift()];



            //check for incest

            if (sbf.msi == sbm.id || sbf.fsi == sbm.id || sbm.msi == sbf.id || sbm.fsi == sbf.id ){
                console.log("didn't breed " + sbf.name + " and " + sbm.name);

                if (fs.length > ms.length) {ms.push(sbm.id)}
                else {fs.push(sbf.id)}
                

            }
            else{

            //only breed sometimes
            //can be buffed
            if (p.heldSheepIds.length < p.maxSheep)
        {
            if (randint(0,10) > 5){
                breedSheep(sbf,sbm);
            }
        }
            
            }


            



            if (fs.length <= 0 || ms.length <= 0){
                done = true;
            }
        }


    }

    function moveSheep(sid, newpid){
        newpid = Math.min(newpid,gd.pastures.length-1)
        newpid = Math.max(0,newpid);
        if (gd.pastures[newpid].heldSheepIds.length < gd.pastures[newpid].maxSheep){
            var s = gd.sheeps[sid];
            if (!s.retired){
                
            var oldpid = s.pid;
            rem(gd.pastures[s.pid].heldSheepIds, sid)
            gd.pastures[newpid].heldSheepIds.push(sid);
            s.pid = newpid;
            log("moved " + s.name + " from " + gd.pastures[oldpid].name + " to " + gd.pastures[newpid].name);
            gd.pastures[newpid].heldSheepIds.sort((a,b) => gd.sheeps[a].id - gd.sheeps[b].id);

            }
            
        }else{
            log ("pasture " + newpid + " full, couldn't move " + s.name);
        }
       
               clickTab(2);
    }

    function renderPastureList(pid){
        var out = "<ul class='tree-view altlist'>";
        var p = gd.pastures[pid];
        for (let si of p.heldSheepIds){
            var s = gd.sheeps[si];
            out +=  "<li onclick='selectandviewsheep(" + s.id + ")'>" + s.name + " - " + s.pattern + " " + s.color + "</li>";
        }
        out += "</ul>"
        return out;
    }

    function renderAllSheepList(){
        var out = "";
        out += "All Sheep" + "<BR><HR><ul class='tree-view' style='height:15em;overflow-y:scroll;width:50%;'>";
        for (let p of gd.pastures){
            out += "<li ><details><summary><button onclick='selectandviewpasture(" + p.id + ")'>" + p.name + "</button> </summary><ul>";


            for (let si of p.heldSheepIds){
                var s = gd.sheeps[si];
                out += "<li onclick='selectandviewsheep(" + s.id + ")'>" +  s.name + "</li>";

            }


            out += "</ul></details></li>"
        }
        out += "</ul>"
        return out;
    }

    function renderSheep(sid){
        var out = "";
        var s = gd.sheeps[sid];
        out += s.id + " - " + s.name + "<br><hr><BR>";
        out += "age: " + s.age + "<BR>";
       
        return out;
    }




    // models

    function gameData(){
        this.time = 0;
        this.sheepIndex = 0;
        this.curPid = 0;
        this.curSid = 0;
        this.pastures = [];
        this.pastures.push(new pasture(0));
        this.pastures.push(new pasture(1));
        this.pastures.push(new pasture(2));
        this.pastures.push(new pasture(3));
        this.sheeps = [];
        this.longlog = [[]];
        
    }


    function pasture(pid){
        this.id = pid;
        this.name = "Pasture " + (this.id+1);
        this.heldSheepIds = []
        this.maxSheep = 24;
    }
   

   function sheep( sx = -1, sy = -1,  cx = -1, cy = -1, g1 = -1, g2 = -1, g3 = -1, ){
    
    this.id = gd.sheepIndex;
    gd.sheepIndex+=1;
    this.name = "sheep "+this.id;
    this.cx = cx;
    this.cy = cy;
    this.sx = sx;
    this.sy = sy;
    if (cx == -1) this.cx = ((randint(0,10)>5));
    if (cy == -1) this.cy = ((randint(0,10)>5));
    if (sx == -1) this.sx = ((randint(0,10)>4));
    if (sy == -1) this.sy = ((randint(0,10)>4));

    if (this.sx || this.sy) { this.pattern = "solid "} else {this.pattern = "spotted "}
    if (this.cx || this.cy) { this.color = "gray"} else {this.color = "white"}
    this.pid = gd.curPid;
    this.age = 0;
    this.female = ((randint(0,10)>5));
    this.g1 = g1;
    this.g2 = g2;
    this.g3 = g3;
    if (g1 == -1) this.g1 = randint(0,10);
    if (g2 == -1) this.g2 = randint(0,10);
    if (g3 == -1) this.g3 = randint(0,10);
    this.dv = Math.random();
    this.sexy = this.g1+this.g2-this.g3;
    this.fsi = -1;
    this.msi = -1;
    this.kids = [];
    this.retired = false;
    
    
   }

        //utility

        window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return; // Do nothing if the event was already processed
  }

  if (event.shiftKey){
    switch(event.key){
        case "Tab":
        if (curtab > 0) {clickTab(curtab - 1)}
        else {clickTab(3)}

            break;

            default:
      return; // Quit when this doesn't handle the key event.
  

    }
  }
  else{
    switch (event.key) {
    case "1":
        if (curtab == 0 || curtab == 1) selectandviewpasture(0)
      if (curtab == 2) moveSheep(gd.curSid,0);
      break;
    case "2":
    if (curtab == 0 || curtab == 1) selectandviewpasture(1)
    if (curtab == 2) moveSheep(gd.curSid,1);
      break;
    case "3":
    if (curtab == 0 || curtab == 1) selectandviewpasture(2)
    if (curtab == 2) moveSheep(gd.curSid,2);
      break;
    case "4":
    if (curtab == 0 || curtab == 1) selectandviewpasture(3)
    if (curtab == 2) moveSheep(gd.curSid,3);
      break;
      case "ArrowLeft":
        if (curtab == 1) prevpast();
        if (curtab == 2) prevsheepall();
      break;
    case "ArrowRight":
    if (curtab == 1) nextpast();
    if (curtab == 2) nextsheepall();
      break;
      case "ArrowUp":
        if (curtab == 1) prevpast();
        if (curtab == 2) prevsheepall();
      break;
    case "ArrowDown":
    if (curtab == 1) nextpast();
    if (curtab == 2) nextsheepall();
      break;
    case "Tab": 
        if (curtab < 3) {clickTab(curtab + 1)}
        else {clickTab(0)}

    break;



    default:
      return; // Quit when this doesn't handle the key event.
  }
  }

 

  // Cancel the default action to avoid it being handled twice
  event.preventDefault();
}, true);

function log(s){
    console.log(s);
    gd.longlog[gd.time].push(s);
}




 function randint(min, max) {
  return Math.floor(Math.random() * (max - min + 1) ) + min;

  
}

function randfrom(myarray){
		return myarray[Math.floor(Math.random() * myarray.length)];
	}

function rem(a, ele) {
    a.forEach((item, index) => {
        if (item === ele) {
            a.splice(index, 1);
        }
    });
    return a;
}



function shuffle (array) { 
  for (let i = array.length - 1; i > 0; i--) { 
    const j = Math.floor(Math.random() * (i + 1)); 
    [array[i], array[j]] = [array[j], array[i]]; 
  } 
  return array; 
}; 

    </script>
    </body>
</html>