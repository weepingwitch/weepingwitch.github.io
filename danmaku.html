<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>d.a.n.m.a.k.u</title>
	<style type="text/css">
	body{
		background-color:black;
		color:cyan;
		-webkit-animation: canvas 60s infinite;
	}
	canvas{
		margin: 0 auto;
		  touch-action:none;
	}
	#main{
		width:420px;
		font-family:monospace;
		border:0px solid white;
		text-align:center;
		position:absolute;
		margin: 0 auto;
		background-color:black;
	}

	canvas {

	}

	@-webkit-keyframes canvas {
	  0%, 100%  { -webkit-filter: hue-rotate(0deg); }
	  50% { -webkit-filter: hue-rotate(360deg); }
	}

	#screen{
		position:relative;
		width:420px;
		height:420px;
		border:0px;
		background-color:black;
	}




	</style>
</head>
<body>

	<div id="main">
		dead.angel.neon.moon.armageddon.kiss.ultra
		<div id="screen">

		</div>
		<div id="scoretext" >score:</div><BR>
			wasd/arrow keys/mouse/touch to move.<BR>
			avoid bullets, but hit the bombs.<BR>
			(ﾉ>ω<)ﾉ :｡･:*:･ﾟ’★,｡･:*:･ﾟ’☆

	</div>





	<script>


	var screendiv = document.getElementById("screen");
	var aw = screendiv.clientWidth;
	var ah = screendiv.clientHeight;
	screendiv.innerHTML="" +
	"<canvas style='z-index:1;position:absolute;top:0;left:0' id='bbcanvas' width='" + aw + "' height='" + ah + "'></canvas>" +
	"<canvas style='z-index:2;position:absolute;top:0;left:0' id='bcanvas' width='" + aw + "' height='" + ah + "'></canvas>" +
	"<canvas style='z-index:3;position:absolute;top:0;left:0' id='mcanvas' width='" + aw + "' height='" + ah + "'></canvas>" +
	"<canvas style='z-index:4;position:absolute;top:0;left:0' id='tcanvas' width='" + aw + "' height='" + ah + "'></canvas>";

	var mc = document.getElementById('mcanvas');
	var tc = document.getElementById('tcanvas');
	var bc = document.getElementById("bcanvas");
	var bbc = document.getElementById("bbcanvas");
	var sdv = document.getElementById("scoretext");
	var mctx = mc.getContext('2d');
	var tctx = tc.getContext('2d');
	var bctx = bc.getContext('2d');
	var bbctx = bbc.getContext('2d');

	var mmode = false;

	var elemLeft = tc.offsetLeft;
	var   elemTop = tc.offsetTop;
	tc.addEventListener('click', function(event) {
		//doclick(scaleInput(event.clientX,event.clientY));
	}, false);

	tc.addEventListener('mousemove', function(event){
	 dotouch(scaleInput(event.clientX,event.clientY));
	 mmode = true;
	}, false);
	tc.addEventListener('mouseleave', function(event){
		ttx = -1;
		tty = -1;
		mmode = false;
	}, false)
	tc.addEventListener("touchstart", function (e) {
	var touch = e.touches[0];
	var mouseEvent = new MouseEvent("mousemove", {
	 clientX: touch.clientX, clientY: touch.clientY
	});
	tc.dispatchEvent(mouseEvent);
	}, false);
	tc.addEventListener("touchmove", function (e) {
	var touch = e.touches[0];
	var mouseEvent = new MouseEvent("mousemove", {
	 clientX: touch.clientX, clientY: touch.clientY
	});
	tc.dispatchEvent(mouseEvent);
	}, false);






	//keep mobile touches from being treated as scrolls
	document.body.addEventListener("touchstart", function (e) {
	if (e.target == uicanv )
	 e.preventDefault();

	}, false);
	document.body.addEventListener("touchend", function (e) {
	if (e.target == uicanv )
	 e.preventDefault();

	}, false);
	document.body.addEventListener("touchmove", function (e) {
	if (e.target == uicanv )
	 e.preventDefault();

	}, false);


	var cdirs = [[-1,0],[1,0],[0,-1],[0,1]];


  var player = {x:220,y:350,speed:2,vel:[0,0]}
  var middirt, topdirt, botdirt = false;
var life = 80;
var score = 0;

var emits = [];

emits.push({'x':200,'y':20,'tick':0,'rate':300,'etick':0,'phase':3});
emits.push({'x':100,'y':40,'tick':0,'rate':300,'etick':0,'phase':0});
emits.push({'x':300,'y':40,'tick':0,'rate':300,'etick':0,'phase':0});
  var bulls = [];
	for (var i = 0; i < 100; i += 1){
	//	bulls.push({'x':randintinc(10,410),'y':randintinc(-600,0),'size':randintinc(5,15),'age':0});
	}

clearcanv(mctx);
clearcanv(tctx);
clearcanv(bctx);

bctx.fillStyle = "brown";
bctx.strokeStyle="white";
  mctx.fillStyle = "cyan";
	tctx.fillStyle = "cyan";
	bbctx.strokeStyle = "rgba(255,100,100,.2)";
tctx.font = "40px monospace";
drawbot();
drawmid();
drawtop();

requestAnimationFrame(drawloop);



var offs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,0],[0,1],[1,-1],[1,0],[1,1]];




//main loop

var dt;
var lastt = -1;

var bgpulse = 0;
var bgtick = 0;
var grazing = false;
var ptime;
function drawloop(tt){
	//console.log("drawloop");
	grazing = false;
	dt = tt - lastt;
	if (lastt == -1){
		dt = 0;
	}
	lastt = tt;
	ptime = (Math.floor(tt/10)/100).toFixed(2);

	life = Math.min(life+(dt/160),100);

	bgtick += dt;
	if (bgtick >= 75){
		bgtick = 0;
		drawbbg();
	}

	//score = score + dt *10;




	emitterloop();

  movebulls();
  if (botdirt)
    drawbot();

		move();

	    drawmid();



	drawtop();




	var newbs = [];
	for (let bb of bulls){
		if (bb.alive){
			newbs.push(bb);
		}
	}
	bulls = newbs;

	sdv.innerHTML = "time: " + ptime + " seconds<BR>score: " + Math.floor(score)+"<BR>*:･ﾟ✧\\(◕ヮ◕\\)";


	if (life >= 0){
		requestAnimationFrame(drawloop);
	}
	else{
		gameover(tt);
	}


}


function gameover(tt){
	life = 0;
	drawtop();
	console.log(tt/1000);

	tctx.fillText("(×_×)⌒☆",50,100);
	tctx.fillText("YOU DIED",100,200);
	tctx.fillText(".｡･ﾟﾟ･(＞_＜)･ﾟﾟ･｡.",10,300);
}

function emitterloop(){
	for (let em of emits){
			em.tick += dt;
			em.etick += dt;

			moveemitter(em);



			if (em.tick >= em.rate){
				em.tick = 0;
				pulseemitter(em);

			}

			if (em.etick >= 5000){
				em.etick = 0;
				em.phase = randintinc(0,20);
			}


	}
}

function moveemitter(em){
em.x += Math.sin(lastt/550)*dt/16;
em.y += Math.cos(lastt/600)*dt/16;
}

function pulseemitter(em){
	switch (em.phase) {
		case 20:
			em.rate = 150;
			emitdown(em);
			break;
		case 19:
			em.rate = 600;
			em.phase = 17;
			break;
		case 18:
		case 17:
			em.rate = 200;
			emitline(em);
			em.phase += 1;
			break;
		case 16:
			em.rate = 500;
			emitaim(em);
			emitdown(em);
			break;
		case 15:
			em.rate = 900;
			emitcircle(em,41);
			emitaim(em);
			em.phase = 14;
			break;
		case 14:
			em.rate = 100;
			emitcircle(em,20)
			em.phase = 15;
			break;
		case 13:
			em.rate = 300;
			emitcircle(em,21);
			em.phase = 11;
			break;
		case 12:
			em.rate = 300;
			emitaim(em);
			em.phase = 13;
			break;
		case 11:
			em.rate = 300;
			emitline(em);
			em.phase = 12;
			break;
		case 10:
			em.rate = 400;
			emitaim(em);
			break;
		case 9:
			em.rate = 600;
			emitcircle(em);
			emitdown(em);
			emitaim(em);
			break;
		case 8:
			em.rate = 200;
			emitcircle(em,69);
			em.phase = 0;
		case 7:
			em.rate = 400;
			emitcircle(em);
			break;
		case 6:
			em.rate = 600;
			em.phase = 3;
			break;
		case 5:
		case 4:
			emitaim(em);
		case 3:
			em.rate = 100;
			emitcircle(em,15);
			em.phase += 1;
			break;
		case 2:
			em.rate = 600;
			emitdown(em);
			em.phase = 0;
			break;
		case 1:
			em.rate = 200;
			emitdown(em);
			em.phase = 2;
			break;
		default:
		case 0:
			em.rate = 200;
			emitdown(em);
			emitaim(em);
			em.phase = 1;
			break;
	}

	//emitcircle(em);
	//
}

function emitaim(em){
	var bdir = normarray([player.x-em.x,player.y-em.y],1.5);
	bulls.push({'x':em.x,'y':em.y,'size':4,'age':0,'alive':true,'bomb':false,'type':1,'dx':bdir[0],'dy':bdir[1]})

}

function emitdown(em){
	bulls.push({'x':em.x + 6,'y':em.y,'size':4,'age':0,'alive':true,'bomb':(randintinc(0,100)<=3),'type':0});
	bulls.push({'x':em.x - 6,'y':em.y,'size':4,'age':0,'alive':true,'bomb':(randintinc(0,100)<=3),'type':0});

}

function emitline(em){
	bulls.push({'x':em.x + 6,'y':em.y,'size':4,'age':0,'alive':true,'bomb':(randintinc(0,100)<=3),'type':0});
	bulls.push({'x':em.x - 6,'y':em.y,'size':4,'age':0,'alive':true,'bomb':(randintinc(0,100)<=3),'type':0});
	bulls.push({'x':em.x + 18,'y':em.y - 3,'size':4,'age':0,'alive':true,'bomb':false,'type':0});
	bulls.push({'x':em.x - 18,'y':em.y - 3,'size':4,'age':0,'alive':true,'bomb':false,'type':0});
	bulls.push({'x':em.x + 30,'y':em.y - 6,'size':4,'age':0,'alive':true,'bomb':false,'type':0});
	bulls.push({'x':em.x - 30,'y':em.y - 6,'size':4,'age':0,'alive':true,'bomb':false,'type':0});

}


function emitcircle(em, emsteps = 9){

	for (var o = 0; o < 2*Math.PI; o += ((2*Math.PI)/emsteps) ){
		var bdir = normarray([Math.cos(o),Math.sin(o)],1.5);
		bulls.push({'x':em.x,'y':em.y,'size':4,'age':0,'alive':true,'bomb':false,'type':1,'dx':bdir[0],'dy':bdir[1]})

	}
}




function movebulls(){
  for (let bb of bulls){
		if (!bb.alive){
			continue;
		}
		bb.lastx = bb.x;
		bb.lasty = bb.y;


switch (bb.type){
	default:
	case 0:
	  bb.y += 1.5 * dt/16;
		break;
	case 1:
		bb.x += bb.dx * dt/16;
		bb.y += bb.dy * dt/16;
		break;
}








		if (sqrmag([bb.x,bb.y],[player.x,player.y]) <= bb.size ){
			if (!bb.bomb){
				life = life-25;

				dohurt(bb.x,bb.y);
				bb.alive = false;
			}

		}
		if (sqrmag([bb.x,bb.y],[player.x,player.y]) <= bb.size * bb.size  + (42)){
			if (bb.bomb){
				dobomb(bb.x,bb.y);
				bb.alive = false;
			}
			else{
				if (bb.alive){
					score += dt*10;
					grazing = true;
				}
			}
		}

		bb.age += dt;
	//	console.log(bb.age/1000);


    if (bb.age > 6000){
			bb.alive = false;
    }
		if (bb.x < 0  || bb.x > 420 || bb.y > 420){
			bb.alive = false;
		}

  }
botdirt = true;
}



function dobomb(bx,by){
	console.log("boom");
	score += 9999;
	bbctx.beginPath();
	bbctx.arc(bx,by,200,0,2*Math.PI);
	bbctx.fill();

	for (let bbb of bulls){
		if (!bbb.alive){
			continue;
		}
		if (sqrmag([bbb.x,bbb.y],[bx,by]) <= 200*200){
			bbb.alive = false;

		}

	}
}


function dohurt(hx,hy){
	bbctx.strokeStyle = "rgba(255,255,255,.8)";
	bbctx.beginPath();
	bbctx.moveTo(hx-6,hy-6);
	bbctx.lineTo(hx+6,hy+6);
	bbctx.moveTo(hx-6,hy+6);
	bbctx.lineTo(hx+6,hy-6);

	bbctx.stroke();
	bbctx.strokeStyle = "rgba(255,100,100,.2)";
}


var ttx=-1;
var tty=-1;

var LEFT = false;
var RIGHT = false;
var UP = false;
var DOWN = false;



////// Arrow keys //////

function move() {

	if(LEFT && !RIGHT) {
		player.vel[0] = -player.speed;
	}
	else if(RIGHT && !LEFT) {
			player.vel[0] = player.speed;

	}
  else{
    player.vel[0] = 0;
  }

  if (DOWN && !UP){
    	player.vel[1] = player.speed;


  }
  else if (UP && !DOWN){
    player.vel[1] = -player.speed;
  }
  else{
    player.vel[1] = 0;
  }


if (mmode){
	if (!comparrays([ttx,tty],[-1,-1])){
		var dvel = [ttx-player.x, tty - player.y];
		if (Math.abs(dvel[0]) < 1 && Math.abs(dvel[1]) < 1){
			player.vel = [0,0];
		}
		else{

			player.vel = normarray(dvel,player.speed)
		}

	}
}




if (!comparrays(player.vel,[0,0])){
  player.vel = normarray(player.vel,player.speed);
  player.x += player.vel[0] * dt / 16;
  player.y += player.vel[1] * dt / 16;


	player.x = Math.max(player.x,15);
	player.y = Math.max(player.y,15);
	player.x = Math.min(player.x,405);
	player.y = Math.min(player.y,405);
  middirt = true;
}
else{
  middirt = false;
}



}

document.onkeydown = function(e) {
	mmode = false;
	if(e.keyCode == 37 || e.keyCode == 65) LEFT = true;
  if(e.keyCode == 38  || e.keyCode == 87) UP = true;
	if(e.keyCode == 39 || e.keyCode == 68) RIGHT = true;
  if(e.keyCode == 40  || e.keyCode == 83) DOWN = true;
}

document.onkeyup = function(e) {
	if(e.keyCode == 37 || e.keyCode == 65) LEFT = false;
  if(e.keyCode == 38 || e.keyCode == 87) UP = false;
	if(e.keyCode == 39  || e.keyCode == 68) RIGHT = false;
  if(e.keyCode == 40  || e.keyCode == 83) DOWN = false;
}



// wooo functions
function clearcanv(cx){
	cx.clearRect(0,0,aw,ah);
}



function dotouch(cp){

	var ccx = cp[0];
	var ccy = cp[1];
	ttx = ccx;
	tty = ccy;

}

function drawtop(){
	clearcanv(tctx);

	tctx.fillRect(Math.floor(420/2)*(1 -(life/100)),0,Math.floor(420*(life/100)),5);
	tctx.fillRect(Math.floor(420/2)*(1 -(life/100)),415,Math.floor(420*(life/100)),5);
	tctx.fillRect(0,Math.floor(420/2)*(1 -(life/100)),5,Math.floor(420*(life/100)));
	tctx.fillRect(415,Math.floor(420/2)*(1 -(life/100)),5,Math.floor(420*(life/100)));
	//tctx.font = "20px Arial";
	//tctx.fillText(Math.floor(score),12,28)
}

function drawbot(){
		clearcanv(bctx);

		//bctx.fillStyle="red";
   for (let bb of bulls){
		 if (!bb.alive){
			 continue;
		 }
     drawbull(bb);
   }
	 //bctx.fillStyle="brown";
	 for (let em of emits){
		 drawemit(em);
	 }

}



function drawmid(){
	clearcanv(mctx);
  drawplayer();

}



function drawbbg(){
	bbctx.strokeStyle = "rgba(200,200,200,.5)";
	bbctx.beginPath();
	bbctx.moveTo(bgpulse*10,-1);
	bbctx.lineTo(bgpulse*10,421);
	bbctx.moveTo((42-bgpulse)*10,-1);
	bbctx.lineTo((42-bgpulse)*10,421);
	bbctx.moveTo(-1,bgpulse*10);
	bbctx.lineTo(421,bgpulse*10);
	bbctx.moveTo(-1,(42-bgpulse)*10);
	bbctx.lineTo(421,(42-bgpulse)*10);
	bbctx.stroke();
	bbctx.fillStyle = "rgba(0,0,0,.2)";
	bbctx.fillRect(0,0,420,420);
	bbctx.fillStyle = "rgba(100,255,255,0.6)";
	bbctx.strokeStyle  = "rgba(255,100,100,.2)";

	bgpulse += 1;
	if (bgpulse >= 42){
		bgpulse = 0;
	}
}

function drawbull(bb){

//	bctx.beginPath();

//	bctx.arc(bb.x+((bb.lastx-bb.x)*3),bb.y+((bb.lasty-bb.y)*3),bb.size/2,0,2*Math.PI);
//	bctx.fill();


	bbctx.beginPath();
	bbctx.arc(bb.x,bb.y,bb.size-1,0,2*Math.PI);
	bbctx.stroke();

	if (bb.bomb){
		bctx.fillStyle = "white";

		bctx.beginPath();
		bctx.arc(bb.x,bb.y,bb.size+4,0,2*Math.PI);
		bctx.stroke();
		bctx.beginPath();
		bctx.moveTo(bb.x+8,bb.y+8);
		bctx.lineTo(bb.x-8,bb.y-8);
		bctx.stroke();
		bctx.beginPath();
		bctx.moveTo(bb.x+8,bb.y-8);
		bctx.lineTo(bb.x-8,bb.y+8);
		bctx.stroke();

}
		bctx.beginPath();
	  bctx.arc(bb.x,bb.y,bb.size,0,2*Math.PI);
	  bctx.fill();
		bctx.stroke();


	if (bb.bomb){
		bctx.fillStyle = "red";
	}


}

function drawemit(bb){
  bctx.beginPath();
  bctx.arc(Math.floor(bb.x),Math.floor(bb.y),3,0,2*Math.PI);
  bctx.fill();
}
function drawplayer(){

	if (grazing){
		mctx.fillStyle = "rgba(100,255,255,.3)";
		mctx.beginPath();
	  mctx.arc(player.x,player.y,10,0,2*Math.PI);
	  mctx.fill();
		mctx.fillStyle = "cyan";
	}

	mctx.fillRect(player.x-2.5,player.y-2.5,5,5);

}


function sqrmag(p1,p2){
	var dx = p2[0] - p1[0];
	var dy = p2[1] - p1[1];
	var res = (dx * dx + dy*dy);
	return res;
}

function arrinarr(smal, larg){
	res = false;
	for (let ara of larg){
		res = res || comparrays(ara,smal)
	}
	return res;
}

function comparrays(array_a, array_b) {
	var rtn = true,
	i, l;
	if (array_a.length === array_b.length) {
		for (i = 0, l = array_a.length; (i < l) && rtn; i += 1) {
			rtn = array_a[i] === array_b[i];
		}
	} else {
		rtn = false;
	}
	return rtn;
}


function randfrom(myarray){
	return myarray[Math.floor(Math.random() * myarray.length)];
}

function randintinc(min, max) {
	return Math.floor(Math.random() * (max - min + 1) ) + min;
}

//account for canvas positioning and scaling
function scaleInput(xv, yv){
	var rect = tc.getBoundingClientRect(),
	scaleX = tc.width / rect.width,
	scaleY = tc.height / rect.height;
	var xval = (xv - rect.left ) * scaleX ,
	yval = (yv - rect.top ) * scaleY;
	return [xval,yval];
}



function normarray(arr, scf=1){
  var armag = Math.sqrt((arr[0] * arr[0]) + (arr[1] * arr[1]));
  var res = [0,0];
  res[0] = (arr[0]/armag) * scf;
  res[1] = (arr[1]/armag) * scf;

  return res;
}


function clonearray(array){
	newarray = [];
	for (i = 0; i < array.length; i++) {
		newarray.push(array[i]);
	}
}
function zClone(thing){
	return JSON.parse(JSON.stringify(thing));
}

function zWrapCoord(x, maxx, min=0){
	var res = x;
	if (x<min)
	res =  x + maxx;
	if (x >= maxx)
	res = x - maxx;
	return res;
}



</script>

</body>
</html>
